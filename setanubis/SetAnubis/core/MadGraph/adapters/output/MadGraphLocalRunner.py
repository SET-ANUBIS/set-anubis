import os
import subprocess
from SetAnubis.core.MadGraph.ports.output.IMadGraphRunner import IMadGraphRunner
import re

class MadGraphLocalRunner(IMadGraphRunner):
    def __init__(self, madgraph_path : str = None):
        if madgraph_path:
            self.madgraph_path : str = madgraph_path
        else :
            self.madgraph_path : str = os.path.abspath(os.path.join(__file__, "..", "..", "..", "..", "..", "..", "..", "External_Integration", "MadGraph", "MG5_aMC_v3_5_8"))
        
        self.__check_madgraph_installation()
        
    def inject_all_cards(self, jobscript, run_card, param_card, pythia_card, madspin_card):
        card_path = self.__card_path()
        
        if not os.path.exists(card_path):
            os.makedirs(card_path)
            
        param_card_path = os.path.join(card_path, "param_card.dat")
        run_card_path = os.path.join(card_path, "run_card.dat")
        pythia_card_path = os.path.join(card_path, "pythia8_card.dat")
        madspin_card_path = os.path.join(card_path, "madspin_card.dat")
        
        jobscript = self.__change_jobscript_card_path(jobscript, param_card_path, run_card_path, pythia_card_path, madspin_card_path)
        
        with open(os.path.join(card_path, "jobscript_param_scan.txt"), 'w', encoding='utf-8') as f:
            f.write(jobscript)
            
        with open(param_card_path, 'w', encoding='utf-8') as f:
            f.write(run_card)
            
        with open(run_card_path, 'w', encoding='utf-8') as f:
            f.write(param_card)
        
        if pythia_card:
            with open(pythia_card_path, 'w', encoding='utf-8') as f:
                f.write(pythia_card)
          
        if madspin_card:  
            with open(madspin_card_path, 'w', encoding='utf-8') as f:
                f.write(madspin_card)
    
    
    
    def run(self, jobscript, run_card, param_card, pythia_card, madspin_card):
        self.inject_all_cards(jobscript, run_card, param_card, pythia_card, madspin_card)
        card_path = self.__card_path()
        jobscript_path = os.path.join(card_path, "jobscript_param_scan.txt")
        MG_COMMAND = f"./bin/mg5_aMC {jobscript_path}"
        
        subprocess.run(
            ["./bin/mg5_aMC", jobscript_path],
            cwd=self.madgraph_path,
            check=True)
        
    def retrieve_events(self, output_dir="db/Temp/madgraph/Events", width_mode = False):
        pass
    
    def __change_jobscript_card_path(self, jobscript, param_card_path, run_card_path, pythia_card_path, madspin_card_path):
        def _replace_path(script, filename, new_path):
            """
            Remplace dans `script` tout token du type 'qqch/filename'
            par `new_path`. Le token est défini comme une suite de
            caractères non blancs finissant par filename.
            """
            pattern = re.compile(r'\S*' + re.escape(filename))
            return pattern.sub(new_path, script)

        jobscript = _replace_path(jobscript, "param_card.dat",      param_card_path)
        jobscript = _replace_path(jobscript, "run_card.dat",        run_card_path)
        jobscript = _replace_path(jobscript, "pythia8_card.dat",    pythia_card_path)
        jobscript = _replace_path(jobscript, "madspin_card.dat",    madspin_card_path)

        return jobscript
    
    def __card_path(self):
        ASSETS_DIR = os.path.abspath(os.path.join(__file__, "..", "..", "..", "..", "..", "..", "..", "Assets"))
        card_path = os.path.join(ASSETS_DIR, "MadGraph", "MadGraphTemp")
        return card_path
    
    def __check_madgraph_installation(self) -> None:
        mg_dir = self.madgraph_path

        expected_paths = {
            "mg5_aMC binary": os.path.join(mg_dir, "bin", "mg5_aMC"),
            "Pythia8 directory": os.path.join(mg_dir, "HEPTools", "pythia8"),
            "LHAPDF6 (py3) directory": os.path.join(mg_dir, "HEPTools", "lhapdf6_py3"),
            "MG5aMC_PY8_interface directory": os.path.join(mg_dir, "HEPTools", "MG5aMC_PY8_interface"),
        }

        missing = []

        for label, path in expected_paths.items():
            if "binary" in label:
                if not os.path.isfile(path):
                    missing.append(f"{label} ({path})")
            else:
                if not os.path.isdir(path):
                    missing.append(f"{label} ({path})")

        if missing:
            missing_str = "\n  - " + "\n  - ".join(missing)
            raise FileNotFoundError(
                f"MadGraph installation seems incomplete in '{mg_dir}'. "
                f"The following items are missing:{missing_str}"
            )
            
if __name__ == "__main__":
    
    aaah = """
    # ************************************************************
    #* MadGraph5_aMC@NLO *
    #* Autogenerated by MadGraphCommandCard *
    # ************************************************************

    import model sm

    define p = g u c d s u~ c~ d~ s~
    define j = g u c d s u~ c~ d~ s~
    define vv = ve ve~
    define ell = e+ e-
    define q = u c d s u~ c~ d~ s~
    set automatic_html_opening False

    import model SM_HeavyN_CKM_AllMasses_LO

    generate p p > n1 ell # [QCD]

    output HNL_Condor_CCDY_qqe

    launch HNL_Condor_CCDY_qqe

    shower=py8

    madspin=ON

    /External_Integration/input_files/param_card.dat
    /External_Integration/input_files/run_card.dat
    /External_Integration/input_files/pythia8_card.dat
    /External_Integration/input_files/madspin_card.dat

    set WN1 auto

    set VeN1 scan:[1.]

    set mN1 scan:[1.0]
    """
    
    madspin_card = """#************************************************************
#*                        MadSpin                           *
#*                                                          *
#*    P. Artoisenet, R. Frederix, R. Rietkerk, O. Mattelaer *
#*                                                          *
#*    Part of the MadGraph5_aMC@NLO Framework...
set spinmode none
set max_weight_ps_point 400
decay t > w+ b, w+ > all all
decay t~ > w- b~, w- > all all
decay w+ > all all
decay w- > all all
decay z > all all
decay n1 > ell ell vv
launch"""

    run_card = """
#*********************************************************************
#                       MadGraph5_aMC@NLO                            
#                                                                    
#                     run_card.dat MadEvent                          
#                                                                    
#  This file is used to set the parameters of the run.               
#                                                                    
#   Lines starting with a '# ' are info or comments                  
#   mind the format:   value    = variable     ! comment             
#*********************************************************************

  tag_1  = run_tag                     ! name of the run
  2000       = nevents              ! Number of unweighted events requested
  0      = iseed                     ! random seed (0 = auto)
  0.001 = req_acc ! required accuracy (-1 = auto determined from nevents)
  -1  = nevt_job

  1      = lpp1                      ! beam 1 type (1=proton)
  1      = lpp2                      ! beam 2 type
  7000.0 = ebeam1                    ! beam 1 energy in GeV
  7000.0 = ebeam2                    ! beam 2 energy in GeV

  nn23lo1 = pdlabel                  ! PDF set
  230000  = lhaid                    ! LHAPDF ID

  False   = fixed_ren_scale
  False   = fixed_fac_scale
  91.188  = scale
  91.188  = dsqrt_q2fact1
  91.188  = dsqrt_q2fact2
  -1      = dynamical_scale_choice
  1.0     = scalefact

  False   = gridpack
  0.0   = time_of_flight
  average = event_norm

  0       = nhel
  2       = sde_strategy

           = custom_fcts

  0.0     = dsqrt_shat

  15.0    = bwcutoff
  True    = cut_decays

  {}      = pt_min_pdg
  {}      = pt_max_pdg

  -1.0    = etaj
  -1.0    = etal
  -1.0    = etajmin
  -1.0    = etalmin
  {}      = eta_min_pdg
  {}      = eta_max_pdg

  -1.0    = drjj
  -1.0    = drll
  -1.0    = drjl
  -1.0    = drjjmax
  -1.0    = drllmax
  -1.0    = drjlmax

  -1.0    = mmjj
  -1.0    = mmll
  -1.0    = mmjjmax
  -1.0    = mmllmax
  {}      = mxx_min_pdg
  {'default': False} = mxx_only_part_antipart

  -1.0    = mmnl
  -1.0    = mmnlmax
  -1.0    = ptllmin
  -1.0    = ptllmax

  -1.0    = xptj
  -1.0    = xptl

  -1.0    = ptj1min
  -1.0    = ptj2min
  -1.0    = ptj1max
  -1.0    = ptj2max
  0       = cutuse

  -1.0    = ptl1min
  -1.0    = ptl2min
  -1.0    = ptl3min
  -1.0    = ptl1max
  -1.0    = ptl2max
  -1.0    = ptl3max

  -1.0    = htjmin
  -1.0    = htjmax
  -1.0    = ihtmin
  -1.0    = ihtmax

  -1.0    = xetamin
  -1.0    = deltaeta

  4       = maxjetflavor

  False    = use_syst
  systematics = none
  !systematics = systematics_program
  !['--mur=0.5,1,2', '--muf=0.5,1,2', '--pdf=errorset'] = systematics_arguments
"""
    pythia_card = """
    !
! Pythia8 cmd card automatically generated by MadGraph5_aMC@NLO
! For more information on the use of the MG5aMC / Pythia8 interface, visit
!    https://cp3.irmp.ucl.ac.be/projects/madgraph/wiki/LOPY8Merging
!
! ==================
! General parameters 
! ==================
!
Main:numberOfEvents      = -1
HEPMCoutput:file         = hepmc.gz
JetMatching:qCut         = -1.0
JetMatching:doShowerKt   = off
JetMatching:nJetMax      = -1
Merging:TMS              = -1.0
Merging:Process          = <set_by_user>
Merging:nJetMax                  = -1
SysCalc:fullCutVariation = off
!
! -------------------------------------------------------------------
! Specify the HEPMC output of the Pythia8 shower...

PartonLevel:ISR = on
PartonLevel:FSR = on

9900012:mayDecay = off
9900014:mayDecay = off
9900016:mayDecay = off

LesHouches:setLifetime = 0"""

    param_card = """
    ######################################################################
## PARAM_CARD AUTOMATICALY GENERATED BY THE UFO  #####################
######################################################################

###################################
## INFORMATION FOR SMINPUTS
###################################
Block SMINPUTS 
    1 1.279400e+02 # aEWM1 
    2 1.174560e-05 # Gf 
    3 1.184000e-01 # aS 

###################################
## INFORMATION FOR MASS
###################################
Block MASS 
    1 5.040000e-03 # MD 
    2 2.550000e-03 # MU 
    3 1.010000e-01 # MS 
    4 1.270000e+00 # MC 
    5 4.700000e+00 # MB 
    6 1.733000e+02 # MT 
   11 5.110000e-04 # Me 
   13 1.056600e-01 # MMU 
   15 1.777000e+00 # MTA 
   23 9.118760e+01 # MZ 
   25 1.257000e+02 # MH 
  9900012 3.000000e+02 # mN1 
  9900014 5.000000e+02 # mN2 
  9900016 1.000000e+03 # mN3 
##  Not dependent paramater.
## Those values should be edited following analytical the 
## analytical expression. Some generator could simply ignore 
## those values and use the analytical expression
  22 0.000000 # a : 0.0 
  24 79.951230 # W+ : cmath.sqrt(MZ**2/2. + cmath.sqrt(MZ**4/4. - (aEW*cmath.pi*MZ**2)/(Gf*cmath.sqrt(2)))) 
  21 0.000000 # g : 0.0 
  9000001 0.000000 # ghA : 0.0 
  9000003 79.951230 # ghWp : cmath.sqrt(MZ**2/2. + cmath.sqrt(MZ**4/4. - (aEW*cmath.pi*MZ**2)/(Gf*cmath.sqrt(2)))) 
  9000004 79.951230 # ghWm : cmath.sqrt(MZ**2/2. + cmath.sqrt(MZ**4/4. - (aEW*cmath.pi*MZ**2)/(Gf*cmath.sqrt(2)))) 
  82 0.000000 # ghG : 0.0 
  12 0.000000 # ve : 0.0 
  14 0.000000 # vm : 0.0 
  16 0.000000 # vt : 0.0 
  251 79.951230 # G+ : cmath.sqrt(MZ**2/2. + cmath.sqrt(MZ**4/4. - (aEW*cmath.pi*MZ**2)/(Gf*cmath.sqrt(2)))) 

###################################
## INFORMATION FOR DECAY
###################################
DECAY   6 1.350000e+00 
DECAY  23 2.495200e+00 
DECAY  24 2.085000e+00 
DECAY  25 4.170000e-03 
DECAY 9900012 3.030000e-01 
DECAY 9900014 1.500000e+00 
DECAY 9900016 1.230000e+01 
##  Not dependent paramater.
## Those values should be edited following analytical the 
## analytical expression. Some generator could simply ignore 
## those values and use the analytical expression
DECAY  22 0.000000 # a : 0.0 
DECAY  21 0.000000 # g : 0.0 
DECAY  9000001 0.000000 # ghA : 0.0 
DECAY  82 0.000000 # ghG : 0.0 
DECAY  12 0.000000 # ve : 0.0 
DECAY  14 0.000000 # vm : 0.0 
DECAY  16 0.000000 # vt : 0.0 
DECAY  11 0.000000 # e- : 0.0 
DECAY  13 0.000000 # mu- : 0.0 
DECAY  15 0.000000 # ta- : 0.0 
DECAY  2 0.000000 # u : 0.0 
DECAY  4 0.000000 # c : 0.0 
DECAY  1 0.000000 # d : 0.0 
DECAY  3 0.000000 # s : 0.0 
DECAY  5 0.000000 # b : 0.0 

###################################
## INFORMATION FOR CKMBLOCK
###################################
Block CKMBLOCK 
    1 2.275910e-01 # cabi 
    2 3.508000e-03 # th13 
    3 4.153900e-02 # th23 
    4 1.200000e+00 # del13 

###################################
## INFORMATION FOR NUMIXING
###################################
Block NUMIXING 
    1 1.000000e+00 # VeN1 
    2 0.000000e+00 # VeN2 
    3 0.000000e+00 # VeN3 
    4 0.000000e+00 # VmuN1 
    5 1.000000e+00 # VmuN2 
    6 0.000000e+00 # VmuN3 
    7 0.000000e+00 # VtaN1 
    8 0.000000e+00 # VtaN2 
    9 1.000000e+00 # VtaN3 

###################################
## INFORMATION FOR YUKAWA
###################################
Block YUKAWA 
    1 5.040000e-03 # ymdo 
    2 2.550000e-03 # ymup 
    3 1.010000e-01 # yms 
    4 1.270000e+00 # ymc 
    5 4.700000e+00 # ymb 
    6 1.733000e+02 # ymt 
   11 5.110000e-04 # yme 
   13 1.056600e-01 # ymm 
   15 1.777000e+00 # ymtau 
#===========================================================
# QUANTUM NUMBERS OF NEW STATE(S) (NON SM PDG CODE)
#===========================================================

Block QNUMBERS 9000001  # ghA 
        1 0  # 3 times electric charge
        2 -1  # number of spin states (2S+1)
        3 1  # colour rep (1: singlet, 3: triplet, 8: octet)
        4 1  # Particle/Antiparticle distinction (0=own anti)
Block QNUMBERS 9000002  # ghZ 
        1 0  # 3 times electric charge
        2 -1  # number of spin states (2S+1)
        3 1  # colour rep (1: singlet, 3: triplet, 8: octet)
        4 1  # Particle/Antiparticle distinction (0=own anti)
Block QNUMBERS 9000003  # ghWp 
        1 3  # 3 times electric charge
        2 -1  # number of spin states (2S+1)
        3 1  # colour rep (1: singlet, 3: triplet, 8: octet)
        4 1  # Particle/Antiparticle distinction (0=own anti)
Block QNUMBERS 9000004  # ghWm 
        1 -3  # 3 times electric charge
        2 -1  # number of spin states (2S+1)
        3 1  # colour rep (1: singlet, 3: triplet, 8: octet)
        4 1  # Particle/Antiparticle distinction (0=own anti)
Block QNUMBERS 82  # ghG 
        1 0  # 3 times electric charge
        2 -1  # number of spin states (2S+1)
        3 8  # colour rep (1: singlet, 3: triplet, 8: octet)
        4 1  # Particle/Antiparticle distinction (0=own anti)
Block QNUMBERS 250  # G0 
        1 0  # 3 times electric charge
        2 3  # number of spin states (2S+1)
        3 1  # colour rep (1: singlet, 3: triplet, 8: octet)
        4 0  # Particle/Antiparticle distinction (0=own anti)
Block QNUMBERS 251  # G+ 
        1 3  # 3 times electric charge
        2 3  # number of spin states (2S+1)
        3 1  # colour rep (1: singlet, 3: triplet, 8: octet)
        4 1  # Particle/Antiparticle distinction (0=own anti)
Block QNUMBERS 9900012  # N1 
        1 0  # 3 times electric charge
        2 5  # number of spin states (2S+1)
        3 1  # colour rep (1: singlet, 3: triplet, 8: octet)
        4 0  # Particle/Antiparticle distinction (0=own anti)
Block QNUMBERS 9900014  # N2 
        1 0  # 3 times electric charge
        2 5  # number of spin states (2S+1)
        3 1  # colour rep (1: singlet, 3: triplet, 8: octet)
        4 0  # Particle/Antiparticle distinction (0=own anti)
Block QNUMBERS 9900016  # N3 
        1 0  # 3 times electric charge
        2 5  # number of spin states (2S+1)
        3 1  # colour rep (1: singlet, 3: triplet, 8: octet)
        4 0  # Particle/Antiparticle distinction (0=own anti)"""
    mlr = MadGraphLocalRunner()
    
    mlr.run(aaah, run_card, param_card, pythia_card, madspin_card)